<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sistema de Registro de Parceiros</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="header">
    <img src="logo4.png" alt="Logo" class="logo" />
    <h1>Sistema de Registro de Parceiros</h1>
  </header>

  <main class="container">
    <section class="form-section">
      <h2>Cadastro de Parceiros</h2>
      <form id="register-form" enctype="multipart/form-data">
        <label for="nome">Nome *</label>
        <input type="text" id="nome" name="nome" required />

        <label for="email">Email *</label>
        <input type="email" id="email" name="email" required />

        <label for="telefone">Telefone *</label>
        <input type="text" id="telefone" name="telefone" required />

        <label for="endereco">Endereço *</label>
        <input type="text" id="endereco" name="endereco" required />

        <label for="cnpj">CNPJ *</label>
        <input type="text" id="cnpj" name="cnpj" required />

        <label for="imagem">Foto *</label>
        <input type="file" id="imagem" name="imagem" accept="image/*" required />

        <button type="submit" id="add-button">Adicionar</button>
      </form>
    </section>

    <section class="table-section">
      <h2>Lista de Parceiros</h2>
      <table id="partners-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nome</th>
            <th>Email</th>
            <th>Telefone</th>
            <th>Endereço</th>
            <th>CNPJ</th>
            <th>Foto</th>
          </tr>
        </thead>
        <tbody>
          <!-- Parceiros carregados via JS -->
        </tbody>
      </table>
    </section>
  </main>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    const SUPABASE_URL = 'https://jpylyvstgewqndjmasqm.supabase.co';
    const SUPABASE_ANON_KEY = 'sua-chave-anonima-aqui';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const form = document.getElementById('register-form');
    const tableBody = document.querySelector('#partners-table tbody');

    async function loadPartners() {
      const { data, error } = await supabase
        .from('parceiros')
        .select('*')
        .order('id', { ascending: false });

      if (error) {
        console.error('Erro ao carregar parceiros:', error);
        return;
      }

      tableBody.innerHTML = '';

      data.forEach(p => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${p.id}</td>
          <td>${p.nome}</td>
          <td>${p.email}</td>
          <td>${p.telefone}</td>
          <td>${p.endereco}</td>
          <td>${p.cnpj}</td>
          <td><img src="${p.imagem_url}" height="50" alt="Foto"></td>
        `;
        tableBody.appendChild(row);
      });
    }

    form.addEventListener('submit', async (event) => {
      event.preventDefault();

      const nome = form.nome.value.trim();
      const email = form.email.value.trim();
      const telefone = form.telefone.value.trim();
      const endereco = form.endereco.value.trim();
      const cnpj = form.cnpj.value.trim();
      const imagemFile = form.imagem.files[0];

      if (!imagemFile) {
        alert('Por favor, selecione uma foto.');
        return;
      }

      // Upload da imagem para Supabase Storage
      const fileExt = imagemFile.name.split('.').pop();
      const fileName = `${Date.now()}.${fileExt}`;
      const filePath = `public/${fileName}`;

      const { error: uploadError } = await supabase.storage
        .from('imagens')
        .upload(filePath, imagemFile);

      if (uploadError) {
        alert('Erro ao enviar a imagem: ' + uploadError.message);
        return;
      }

      // Obter URL pública da imagem
      const { publicURL, error: urlError } = supabase.storage
        .from('imagens')
        .getPublicUrl(filePath);

      if (urlError) {
        alert('Erro ao obter URL da imagem: ' + urlError.message);
        return;
      }

      // Inserir dados no banco
      const { error: insertError } = await supabase
        .from('parceiros')
        .insert([
          {
            nome,
            email,
            telefone,
            endereco,
            cnpj,
            imagem_url: publicURL
          }
        ]);

      if (insertError) {
        alert('Erro ao cadastrar parceiro: ' + insertError.message);
        return;
      }

      alert('Parceiro cadastrado com sucesso!');
      form.reset();
      loadPartners();
    });

    loadPartners();
  </script>
</body>
</html>
